
@using Spectre.Console
@using System.Linq
@using System.Threading.Tasks
@inject NavShieldAppService AppService

@if (!_initialized)
{
    <Markup Content="Inicializando NavShieldTracer..." Foreground="@Color.Cyan1" />
}
else
{
    @if (UseCompactLayout)
    {
        <Markup Content="NavShieldTracer" Foreground="@Color.Cyan1" Decoration="@Decoration.Bold" />
    }
    else
    {
        foreach (var line in _bannerLines)
        {
            <Markup Content="@line" Foreground="@Color.Cyan1" Decoration="@Decoration.Bold" />
        }
    }
    <Newline />
    <Markup Content="Console SecOps Toolkit v2.0" Foreground="@Color.White" />
    <Markup Content="Real-time Sysmon Event Correlation · MITRE ATT&CK Behavioral Monitoring" Foreground="@Color.Grey" />
    <Newline />

    <DashboardHeader Dashboard="_dashboard"
                     SysmonStatus="_sysmonStatus"
                     CurrentTime="_now" />

    <Newline />
    <Markup Content="Navegacao" Decoration="@Decoration.Bold" />
    @if (UseCompactLayout)
    {
        <Rows>
            <TextButton Content="Dashboard"
                        BackgroundColor='@(_activeTab == AppTab.Overview ? Color.DodgerBlue1 : Color.Grey19)'
                        FocusedColor="@Color.Cyan1"
                        OnClick='@(() => SetTab(AppTab.Overview))' />
            <TextButton Content="Monitorar"
                        BackgroundColor='@(_activeTab == AppTab.Monitor ? Color.DodgerBlue1 : Color.Grey19)'
                        FocusedColor="@Color.Cyan1"
                        OnClick='@(() => SetTab(AppTab.Monitor))' />
            <TextButton Content="Catalogar"
                        BackgroundColor='@(_activeTab == AppTab.Catalog ? Color.DodgerBlue1 : Color.Grey19)'
                        FocusedColor="@Color.Cyan1"
                        OnClick='@(() => SetTab(AppTab.Catalog))' />
            <TextButton Content="Testes"
                        BackgroundColor='@(_activeTab == AppTab.Tests ? Color.DodgerBlue1 : Color.Grey19)'
                        FocusedColor="@Color.Cyan1"
                        OnClick='@(() => SetTab(AppTab.Tests))' />
            <TextButton Content="Gerenciar"
                        BackgroundColor='@(_activeTab == AppTab.Manage ? Color.DodgerBlue1 : Color.Grey19)'
                        FocusedColor="@Color.Cyan1"
                        OnClick='@(() => SetTab(AppTab.Manage))' />
        </Rows>
    }
    else
    {
        <Columns>
            <TextButton Content="Dashboard"
                        BackgroundColor='@(_activeTab == AppTab.Overview ? Color.DodgerBlue1 : Color.Grey19)'
                        FocusedColor="@Color.Cyan1"
                        OnClick='@(() => SetTab(AppTab.Overview))' />
            <TextButton Content="Monitorar"
                        BackgroundColor='@(_activeTab == AppTab.Monitor ? Color.DodgerBlue1 : Color.Grey19)'
                        FocusedColor="@Color.Cyan1"
                        OnClick='@(() => SetTab(AppTab.Monitor))' />
            <TextButton Content="Catalogar"
                        BackgroundColor='@(_activeTab == AppTab.Catalog ? Color.DodgerBlue1 : Color.Grey19)'
                        FocusedColor="@Color.Cyan1"
                        OnClick='@(() => SetTab(AppTab.Catalog))' />
            <TextButton Content="Testes"
                        BackgroundColor='@(_activeTab == AppTab.Tests ? Color.DodgerBlue1 : Color.Grey19)'
                        FocusedColor="@Color.Cyan1"
                        OnClick='@(() => SetTab(AppTab.Tests))' />
            <TextButton Content="Gerenciar"
                        BackgroundColor='@(_activeTab == AppTab.Manage ? Color.DodgerBlue1 : Color.Grey19)'
                        FocusedColor="@Color.Cyan1"
                        OnClick='@(() => SetTab(AppTab.Manage))' />
        </Columns>
    }

    <Newline />

    @switch (_activeTab)
    {
        case AppTab.Overview:
        {
            <Panel Title="Status do Sysmon" BorderColor="@Color.Green">
                <Grid Columns="2">
                    <Markup Content="Servico:" />
                    <Markup Content='@(_sysmonStatus.ServiceRunning ? "Em execucao" : "Parado")'
                            Foreground='@(_sysmonStatus.ServiceRunning ? Color.Green : Color.Red)' />
                    <Markup Content="Acesso ao Log:" />
                    <Markup Content='@(_sysmonStatus.HasAccess ? "OK" : "Sem permissao")'
                            Foreground='@(_sysmonStatus.HasAccess ? Color.Green : Color.Red)' />
                    <Markup Content="Status Geral:" />
                    <Markup Content='@(_sysmonStatus.IsReady ? "Pronto" : "Atencao")'
                            Foreground='@(_sysmonStatus.IsReady ? Color.Green : Color.Yellow)'
                            Decoration='@(_sysmonStatus.IsReady ? Decoration.Bold : Decoration.None)' />
                </Grid>
                @if (_sysmonStatus.Recommendations.Count > 0)
                {
                    <Newline />
                    <Markup Content="Recomendacoes:" Foreground="@Color.Yellow" Decoration="@Decoration.Bold" />
                    @foreach (var rec in _sysmonStatus.Recommendations.Take(3))
                    {
                        <Markup Content='@Spectre.Console.Markup.Escape(rec)' Foreground="@Color.Yellow" />
                    }
                }
                <Newline />
                <Grid Columns="2">
                    <Markup Content="Testes catalogados:" />
                    <Markup Content='@_dashboard.TotalTestes.ToString()' Foreground="@Color.Cyan1" />
                    <Markup Content="Eventos armazenados:" />
                    <Markup Content='@_dashboard.TotalEventos.ToString()' Foreground="@Color.Cyan1" />
                    <Markup Content="Banco de dados:" />
                    <Markup Content='@Spectre.Console.Markup.Escape(_dashboard.DatabasePath)' Foreground="@Color.Grey" />
                </Grid>
            </Panel>
            break;
        }

        case AppTab.Monitor:
        {
            <MonitorTab UseCompactLayout="UseCompactLayout"
                        SysmonStatus="_sysmonStatus"
                        ActiveSession="_activeSession"
                        CriticalEventCounts="_criticalEventCounts"
                        CurrentTime="_now"
                        OnSessionStateChanged="HandleMonitorSessionChangedAsync" />
            break;
        }

        case AppTab.Catalog:
        {
            <Panel Title="Catalogar Teste Atomico" BorderColor="@Color.Yellow">
                <Markup Content="Preencha os dados do teste MITRE ATT&CK:" />
                <TextInput Label="Numero (ex: T1055)" @bind-Value="_catalogNumero" />
                <TextInput Label="Nome" @bind-Value="_catalogNome" />
                <TextInput Label="Descricao" @bind-Value="_catalogDescricao" />
                <TextInput Label="Executavel alvo" @bind-Value="_catalogTarget" Placeholder="teste.exe" />
                <Newline />
                <Columns>
                    <TextButton Content="Iniciar Catalogacao"
                                BackgroundColor="@Color.Green"
                                FocusedColor="@Color.Green3"
                                OnClick="@StartCatalogAsync" />
                    <TextButton Content="Limpar"
                                BackgroundColor="@Color.Grey37"
                                FocusedColor="@Color.Grey70"
                                OnClick="@ClearCatalogForm" />
                </Columns>
                @if (!string.IsNullOrEmpty(_catalogError))
                {
                    <Newline />
                    <Markup Content="@_catalogError" Foreground="@Color.Red" />
                }
            </Panel>
            break;
        }

        case AppTab.Tests:
        {
            <Panel Title="Testes Catalogados" BorderColor="@Color.Blue">
                <Grid Columns="2">
                    <Markup Content="Total de testes:" />
                    <Markup Content='@_testes.Count.ToString()' Foreground="@Color.Cyan1" />
                </Grid>
                <Newline />
                @if (_testes.Count == 0)
                {
                    <Markup Content="Nenhum teste catalogado ainda." Foreground="@Color.Grey" />
                }
                else
                {
                    <SpectreTable ShowHeaders="true" Expand="true">
                        <SpectreTHead>
                            <SpectreTR>
                                <SpectreTH><Markup Content="ID" /></SpectreTH>
                                <SpectreTH><Markup Content="Numero" /></SpectreTH>
                                <SpectreTH><Markup Content="Nome" /></SpectreTH>
                                <SpectreTH><Markup Content="Execucao" /></SpectreTH>
                                <SpectreTH><Markup Content="Eventos" /></SpectreTH>
                            </SpectreTR>
                        </SpectreTHead>
                        <SpectreTBody>
                            @foreach (var teste in _testes.Take(10))
                            {
                                <SpectreTR>
                                    <SpectreTD><Markup Content='@teste.Id.ToString()' Foreground="@Color.Cyan1" /></SpectreTD>
                                    <SpectreTD><Markup Content='@Spectre.Console.Markup.Escape(teste.Numero)' Foreground="@Color.Yellow" /></SpectreTD>
                                    <SpectreTD><Markup Content='@Spectre.Console.Markup.Escape(teste.Nome)' /></SpectreTD>
                                    <SpectreTD><Markup Content='@teste.DataExecucao.ToString("dd/MM HH:mm")' Foreground="@Color.Grey" /></SpectreTD>
                                    <SpectreTD><Markup Content='@teste.TotalEventos.ToString()' Foreground="@Color.Cyan1" /></SpectreTD>
                                </SpectreTR>
                            }
                        </SpectreTBody>
                    </SpectreTable>
                }
                <Newline />
                <TextInput Label="ID do teste para exportar" @bind-Value="_testsIdInput" />
                <TextButton Content="Exportar JSON"
                            BackgroundColor="@Color.Blue"
                            FocusedColor="@Color.Blue3"
                            OnClick="@ExportSelectedTesteAsync" />
                @if (!string.IsNullOrEmpty(_exportMessage))
                {
                    <Newline />
                    <Markup Content="@_exportMessage" Foreground='@ResolveExportColor(_exportMessage)' />
                }
            </Panel>
            break;
        }

        case AppTab.Manage:
        {
            <Panel Title="Gerenciar Testes" BorderColor="@Color.Orange3">
                <Markup Content="Carregue um teste para editar:" />
                <TextInput Label="ID do teste" @bind-Value="_manageIdInput" />
                <TextButton Content="Carregar"
                            BackgroundColor="@Color.Grey37"
                            FocusedColor="@Color.Grey70"
                            OnClick="@LoadManageTesteAsync" />
                @if (_manageTeste is not null)
                {
                    <Newline />
                    <TextInput Label="Numero" @bind-Value="_manageNumero" />
                    <TextInput Label="Nome" @bind-Value="_manageNome" />
                    <TextInput Label="Descricao" @bind-Value="_manageDescricao" />
                    <Newline />
                    <Columns>
                        <TextButton Content="Salvar"
                                    BackgroundColor="@Color.Green"
                                    FocusedColor="@Color.Green3"
                                    OnClick="@SaveManageTesteAsync" />
                        <TextButton Content="Excluir"
                                    BackgroundColor="@Color.Red"
                                    FocusedColor="@Color.Red3"
                                    OnClick="@DeleteManageTesteAsync" />
                    </Columns>
                }
                @if (!string.IsNullOrEmpty(_manageMessage))
                {
                    <Newline />
                    <Markup Content="@_manageMessage" Foreground='@ResolveManageColor(_manageMessage)' />
                }
            </Panel>
            break;
        }
    }

    <Newline />
    <Markup Content="Use TAB para navegar | ENTER para selecionar" Foreground="@Color.Grey" />
}

@code {
    private enum AppTab { Overview, Monitor, Catalog, Tests, Manage }

    private static readonly string[] _bannerLines =
    {
        "███╗   ██╗█████╗ ██╗   ██╗███████╗██╗  ██╗██╗███████╗██╗     ██████╗",
        "████╗  ██║██╔══██╗██║   ██║██╔════╝██║  ██║██║██╔════╝██║     ██╔══██╗",
        "██╔██╗ ██║███████║██║   ██║███████╗███████║██║█████╗  ██║     ██║  ██║",
        "██║╚██╗██║██╔══██║╚██╗ ██╔╝╚════██║██╔══██║██║██╔══╝  ██║     ██║  ██║",
        "██║ ╚████║██║  ██║ ╚████╔╝ ███████║██║  ██║██║███████╗███████╗██████╔╝",
        "╚═╝  ╚═══╝╚═╝  ╚═╝  ╚═══╝ ╚══════╝╚═╝  ╚═╝╚═╝╚══════╝╚══════╝╚═════╝ "
    };

    private DateTime _now = DateTime.Now;
    private DashboardSnapshot _dashboard = null!;
    private SysmonStatus _sysmonStatus = null!;
    private MonitoringSessionSnapshot? _activeSession;
    private IReadOnlyDictionary<int, int> _criticalEventCounts = new Dictionary<int, int>();
    private AppTab _activeTab = AppTab.Overview;
    private bool _initialized;
    private CancellationTokenSource? _refreshLoop;

    // Catalog tab
    private string _catalogNumero = "";
    private string _catalogNome = "";
    private string _catalogDescricao = "";
    private string _catalogTarget = "teste.exe";
    private string? _catalogError;

    // Tests tab
    private IReadOnlyList<TesteAtomico> _testes = Array.Empty<TesteAtomico>();
    private string _testsIdInput = "";
    private string? _exportMessage;

    // Manage tab
    private string _manageIdInput = "";
    private TesteAtomico? _manageTeste;
    private string? _manageNumero;
    private string? _manageNome;
    private string? _manageDescricao;
    private string? _manageMessage;

    private bool UseCompactLayout => Console.WindowWidth < 110;
    protected override async Task OnInitializedAsync()
    {
        await RefreshDashboardAsync().ConfigureAwait(false);
        await RefreshMonitorSnapshotAsync().ConfigureAwait(false);
        _initialized = true;
        StartRefreshLoop();
    }

    public void Dispose()
    {
        _refreshLoop?.Cancel();
        _refreshLoop?.Dispose();
    }

    private async Task RefreshDashboardAsync()
    {
        _sysmonStatus = await AppService.RefreshSysmonStatusAsync().ConfigureAwait(false);
        _dashboard = AppService.GetDashboardSnapshot();
    }

    private Task RefreshMonitorSnapshotAsync()
    {
        return Task.Run(() =>
        {
            MonitoringSessionSnapshot? snapshot = null;
            IReadOnlyDictionary<int, int> critical;

            try
            {
                snapshot = AppService.GetActiveSessionSnapshot();
            }
            catch
            {
                snapshot = null;
            }

            if (snapshot is not null)
            {
                try
                {
                    critical = AppService.GetCriticalEventCounts(snapshot.SessionId);
                }
                catch
                {
                    critical = new Dictionary<int, int>();
                }
            }
            else
            {
                critical = new Dictionary<int, int>();
            }

            _activeSession = snapshot;
            _criticalEventCounts = critical;
        });
    }

    private void SetTab(AppTab tab)
    {
        _activeTab = tab;
        if (tab == AppTab.Tests || tab == AppTab.Manage)
        {
            _testes = AppService.ListarTestes();
        }
    }

    private void StartRefreshLoop()
    {
        _refreshLoop?.Cancel();
        _refreshLoop = new CancellationTokenSource();
        var token = _refreshLoop.Token;
        _ = Task.Run(async () =>
        {
            var fastTimer = new PeriodicTimer(TimeSpan.FromSeconds(1));
            var statusInterval = TimeSpan.FromSeconds(5);
            var lastStatusSync = DateTime.MinValue;
            try
            {
                while (await fastTimer.WaitForNextTickAsync(token).ConfigureAwait(false))
                {
                    _now = DateTime.Now;

                    try
                    {
                        await RefreshMonitorSnapshotAsync().ConfigureAwait(false);
                    }
                    catch
                    {
                        // Se a sessao finalizar durante a leitura, ignore o erro e mantenha o estado atual.
                    }

                    if ((_now - lastStatusSync) >= statusInterval)
                    {
                        try
                        {
                            await RefreshDashboardAsync().ConfigureAwait(false);
                        }
                        catch
                        {
                            // Ignora atualizacao pontual; o proximo ciclo tentara novamente.
                        }
                        lastStatusSync = _now;
                    }

                    await InvokeAsync(StateHasChanged).ConfigureAwait(false);
                }
            }
            catch (OperationCanceledException)
            {
                // Loop finalizado ao descartar o componente.
            }
        }, token);
    }

    private async Task StartCatalogAsync()
    {
        if (string.IsNullOrWhiteSpace(_catalogNumero) || string.IsNullOrWhiteSpace(_catalogNome))
        {
            _catalogError = "Informe numero e nome do teste.";
            return;
        }

        try
        {
            _catalogError = null;
            var novo = new NovoTesteAtomico(_catalogNumero.Trim(), _catalogNome.Trim(), _catalogDescricao?.Trim() ?? string.Empty);
            var alvo = string.IsNullOrWhiteSpace(_catalogTarget) ? "teste.exe" : _catalogTarget.Trim();
            AppService.StartCatalog(novo, alvo);
            await HandleMonitorSessionChangedAsync().ConfigureAwait(false);
        }
        catch (Exception ex)
        {
            _catalogError = ex.Message;
        }
    }

    private void ClearCatalogForm()
    {
        _catalogNumero = "";
        _catalogNome = "";
        _catalogDescricao = "";
        _catalogTarget = "teste.exe";
        _catalogError = null;
    }

    private async Task ExportSelectedTesteAsync()
    {
        if (!int.TryParse(_testsIdInput, out var id))
        {
            _exportMessage = "ID invalido.";
            return;
        }

        try
        {
            var path = await AppService.ExportarTesteAsync(id).ConfigureAwait(false);
            _exportMessage = $"Exportado para: {path}";
        }
        catch (Exception ex)
        {
            _exportMessage = $"Erro: {ex.Message}";
        }
    }

    private async Task LoadManageTesteAsync()
    {
        if (!int.TryParse(_manageIdInput, out var id))
        {
            _manageMessage = "ID invalido.";
            return;
        }

        var teste = AppService.ListarTestes().FirstOrDefault(t => t.Id == id);
        if (teste is null)
        {
            _manageMessage = "Teste nao encontrado.";
            _manageTeste = null;
            return;
        }

        _manageTeste = teste;
        _manageNumero = teste.Numero;
        _manageNome = teste.Nome;
        _manageDescricao = teste.Descricao;
        _manageMessage = null;
        await InvokeAsync(StateHasChanged).ConfigureAwait(false);
    }

    private async Task SaveManageTesteAsync()
    {
        if (_manageTeste is null)
        {
            _manageMessage = "Carregue um teste primeiro.";
            return;
        }

        var ok = AppService.AtualizarTeste(_manageTeste.Id, _manageNumero, _manageNome, _manageDescricao);
        _manageMessage = ok ? "Salvo com sucesso!" : "Falha ao salvar.";
        if (ok)
        {
            _testes = AppService.ListarTestes();
        }
        await InvokeAsync(StateHasChanged).ConfigureAwait(false);
    }

    private async Task DeleteManageTesteAsync()
    {
        if (_manageTeste is null)
        {
            _manageMessage = "Carregue um teste primeiro.";
            return;
        }

        var ok = AppService.ExcluirTeste(_manageTeste.Id);
        _manageMessage = ok ? "Teste excluido!" : "Falha ao excluir.";
        if (ok)
        {
            _manageTeste = null;
            _manageNumero = null;
            _manageNome = null;
            _manageDescricao = null;
            _testes = AppService.ListarTestes();
        }
        await InvokeAsync(StateHasChanged).ConfigureAwait(false);
    }

    private async Task HandleMonitorSessionChangedAsync()
    {
        await RefreshMonitorSnapshotAsync().ConfigureAwait(false);
        await RefreshDashboardAsync().ConfigureAwait(false);
        if (_activeTab == AppTab.Tests || _activeTab == AppTab.Manage)
        {
            _testes = AppService.ListarTestes();
        }
        await InvokeAsync(StateHasChanged).ConfigureAwait(false);
    }

    private static Color ResolveExportColor(string message)
        => message.StartsWith("Erro:", StringComparison.OrdinalIgnoreCase) ? Color.Red : Color.Green;

    private static Color ResolveManageColor(string message)
    {
        if (message.Contains("sucesso", StringComparison.OrdinalIgnoreCase) || message.Contains("excluido", StringComparison.OrdinalIgnoreCase))
        {
            return Color.Green;
        }

        if (message.Contains("falha", StringComparison.OrdinalIgnoreCase) || message.Contains("nao", StringComparison.OrdinalIgnoreCase))
        {
            return Color.Red;
        }

        return Color.Yellow;
    }
}
