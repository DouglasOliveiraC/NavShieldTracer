@using Spectre.Console
@using System.Linq
@using NavShieldTracer.Modules.Heuristics.Engine
@using HeuristicThreatSeverityTarja = NavShieldTracer.Modules.Heuristics.Normalization.ThreatSeverityTarja
@inject NavShieldAppService AppService

<Panel Title="Monitoramento em Tempo Real" BorderColor="@Color.Cyan1">
    <Markup Content="Digite o nome do executavel para monitorar:" />
    <TextInput @bind-Value="_monitorTarget" Placeholder="exemplo: chrome.exe" />
    <Newline />
    @if (UseCompactLayout)
    {
        <Rows>
            <TextButton Content="Iniciar"
                        BackgroundColor="@Color.Green"
                        FocusedColor="@Color.Green3"
                        OnClick="@StartMonitorAsync" />
            <TextButton Content="Parar"
                        BackgroundColor="@Color.Red"
                        FocusedColor="@Color.Red3"
                        OnClick="@StopMonitorAsync" />
        </Rows>
    }
    else
    {
        <Columns>
            <TextButton Content="Iniciar"
                        BackgroundColor="@Color.Green"
                        FocusedColor="@Color.Green3"
                        OnClick="@StartMonitorAsync" />
            <TextButton Content="Parar"
                        BackgroundColor="@Color.Red"
                        FocusedColor="@Color.Red3"
                        OnClick="@StopMonitorAsync" />
        </Columns>
    }

    @if (!string.IsNullOrEmpty(_monitorError))
    {
        <Newline />
        <Markup Content="@_monitorError" Foreground="@Color.Red" />
    }

    @if (ActiveSession is not null)
    {
        var heuristicSnapshot = ActiveSession.HeuristicSnapshot;
        var threatLevel = heuristicSnapshot?.SessionThreatLevel ?? HeuristicThreatSeverityTarja.Verde;
        var threatColor = ResolveThreatColor(threatLevel);
        var highestMatch = heuristicSnapshot?.HighestMatch;
        var duration = CurrentTime - ActiveSession.StartedAt;
        var logsDisponiveis = ActiveSession.Logs.TakeLast(MaxLogs).ToList();

        <Newline />

        @if (UseCompactLayout)
        {
            <Rows>
                <Panel Title="Sessao Ativa" BorderColor="@Color.Green">
                    <Grid Columns="2">
                        <Markup Content="Monitorando:" />
                        <Markup Content='@ActiveSession.TargetExecutable' Foreground="@Color.Green" />
                        <Markup Content="Eventos capturados:" />
                        <Markup Content='@ActiveSession.TotalEventos.ToString()' Foreground="@Color.Cyan1" />
                        <Markup Content="Processos ativos:" />
                        <Markup Content='@ActiveSession.Statistics.ProcessosAtivos.ToString()' Foreground="@Color.Yellow" />
                        <Markup Content="Processos encerrados:" />
                        <Markup Content='@ActiveSession.Statistics.ProcessosEncerrados.ToString()' Foreground="@Color.Yellow" />
                    </Grid>
                </Panel>
                <Panel Title="Status do Sistema" BorderColor='@threatColor'>
                    <Grid Columns="2">
                        <Markup Content="Nivel de Alerta:" />
                        <Markup Content='@ResolveThreatText(threatLevel)'
                                Foreground='@threatColor'
                                Decoration="@Decoration.Bold" />
                        <Markup Content="Sysmon:" />
                        <Markup Content='@(SysmonStatus.ServiceRunning ? "Online" : "Offline")'
                                Foreground='@(SysmonStatus.ServiceRunning ? Color.Green : Color.Red)' />
                        <Markup Content="Duracao:" />
                        <Markup Content='@duration.ToString("hh\\:mm\\:ss")' Foreground="@Color.Cyan1" />
                        <Markup Content="Media encerrados:" />
                        <Markup Content='@((ActiveSession.Statistics.TempoMedioDeVidaEncerrados?.ToString("hh\\:mm\\:ss")) ?? "--")' />
                    </Grid>
                </Panel>
            </Rows>
        }
        else
        {
            <Columns>
                <Panel Title="Sessao Ativa" BorderColor="@Color.Green">
                    <Grid Columns="2">
                        <Markup Content="Monitorando:" />
                        <Markup Content='@ActiveSession.TargetExecutable' Foreground="@Color.Green" />
                        <Markup Content="Eventos capturados:" />
                        <Markup Content='@ActiveSession.TotalEventos.ToString()' Foreground="@Color.Cyan1" />
                        <Markup Content="Processos ativos:" />
                        <Markup Content='@ActiveSession.Statistics.ProcessosAtivos.ToString()' Foreground="@Color.Yellow" />
                        <Markup Content="Processos encerrados:" />
                        <Markup Content='@ActiveSession.Statistics.ProcessosEncerrados.ToString()' Foreground="@Color.Yellow" />
                    </Grid>
                </Panel>
                <Panel Title="Status do Sistema" BorderColor='@threatColor'>
                    <Grid Columns="2">
                        <Markup Content="Nivel de Alerta:" />
                        <Markup Content='@ResolveThreatText(threatLevel)'
                                Foreground='@threatColor'
                                Decoration="@Decoration.Bold" />
                        <Markup Content="Sysmon:" />
                        <Markup Content='@(SysmonStatus.ServiceRunning ? "Online" : "Offline")'
                                Foreground='@(SysmonStatus.ServiceRunning ? Color.Green : Color.Red)' />
                        <Markup Content="Duracao:" />
                        <Markup Content='@duration.ToString("hh\\:mm\\:ss")' Foreground="@Color.Cyan1" />
                        <Markup Content="Media encerrados:" />
                        <Markup Content='@((ActiveSession.Statistics.TempoMedioDeVidaEncerrados?.ToString("hh\\:mm\\:ss")) ?? "--")' />
                    </Grid>
                </Panel>
            </Columns>
        }

        <Newline />
        <Panel Title="Analise Heuristica" BorderColor='@threatColor'>
            @if (heuristicSnapshot is null)
            {
                <Markup Content="Monitor heuristico aguardando eventos suficientes para avaliar esta sessao."
                        Foreground="@Color.Grey70" />
            }
            else
            {
                <Grid Columns="2">
                    <Markup Content="Atualizado:" />
                    <Markup Content='@heuristicSnapshot.SnapshotAt.ToString("HH\\:mm\\:ss")' Foreground="@Color.Silver" />
                    <Markup Content="Eventos analisados:" />
                    <Markup Content='@heuristicSnapshot.EventCountAtSnapshot.ToString()' Foreground="@Color.Cyan1" />
                    <Markup Content="Processos ativos:" />
                    <Markup Content='@heuristicSnapshot.ActiveProcessesCount.ToString()' Foreground="@Color.Yellow" />
                    <Markup Content="Tarja heuristica:" />
                    <Markup Content='@ResolveThreatText(heuristicSnapshot.SessionThreatLevel)'
                            Foreground='@ResolveThreatColor(heuristicSnapshot.SessionThreatLevel)'
                            Decoration="@Decoration.Bold" />
                    @if (highestMatch is not null)
                    {
                        var matchColor = ResolveThreatColor(highestMatch.ThreatLevel);
                        <Markup Content="Tecnica dominante:" />
                        <Markup Content='@($"{highestMatch.TechniqueId} - {Spectre.Console.Markup.Escape(highestMatch.TechniqueName)}")'
                                Foreground='@matchColor' />
                        <Markup Content="Similaridade:" />
                        <Markup Content='@highestMatch.Similarity.ToString("P1")' Foreground="@Color.Cyan1" />
                        <Markup Content="Confianca:" />
                        <Markup Content='@highestMatch.Confidence.ToUpperInvariant()' Foreground="@Color.Cyan1" />
                    }
                    else
                    {
                        <Markup Content="Tecnica dominante:" />
                        <Markup Content="Nenhuma correlacao ativa" Foreground="@Color.Grey70" />
                    }
                </Grid>

                @if (heuristicSnapshot.Matches.Any())
                {
                    var topMatches = heuristicSnapshot.Matches
                        .OrderByDescending(m => m.Similarity)
                        .Take(3)
                        .ToList();

                    <Newline />
                    <SpectreTable Border="@TableBorder.Rounded" BorderColor="@Color.Grey" ShowHeaders="true">
                        <SpectreTHead>
                            <SpectreTR>
                                <SpectreTH><Markup Content="Tecnica" /></SpectreTH>
                                <SpectreTH><Markup Content="Tarja" /></SpectreTH>
                                <SpectreTH><Markup Content="Similaridade" /></SpectreTH>
                                <SpectreTH><Markup Content="Confianca" /></SpectreTH>
                            </SpectreTR>
                        </SpectreTHead>
                        <SpectreTBody>
                            @foreach (var match in topMatches)
                            {
                                var matchColor = ResolveThreatColor(match.ThreatLevel);
                                <SpectreTR>
                                    <SpectreTD>
                                        <Markup Content='@($"{match.TechniqueId} - {Spectre.Console.Markup.Escape(match.TechniqueName)}")'
                                                Foreground='@matchColor' />
                                    </SpectreTD>
                                    <SpectreTD>
                                        <Markup Content='@ResolveThreatText(match.ThreatLevel)'
                                                Foreground='@matchColor' />
                                    </SpectreTD>
                                    <SpectreTD>
                                        <Markup Content='@match.Similarity.ToString("P1")' Foreground="@Color.Cyan1" />
                                    </SpectreTD>
                                    <SpectreTD>
                                        <Markup Content='@match.Confidence.ToUpperInvariant()' Foreground="@Color.Cyan1" />
                                    </SpectreTD>
                                </SpectreTR>
                            }
                        </SpectreTBody>
                    </SpectreTable>
                }
            }
        </Panel>

        @if (ActiveSession.Statistics.ProcessosAtivosDetalhados.Count > 0)
        {
            var totalProcessos = ActiveSession.Statistics.ProcessosAtivosDetalhados.Count;
            var processosVisiveis = Math.Min(MaxProcessosVisiveis, totalProcessos);

            <Newline />
            <Markup Content='@($"Top {processosVisiveis} processos (Total: {totalProcessos})")'
                    Foreground="@Color.Grey"
                    Decoration="@Decoration.Bold" />
            <SpectreTable ShowHeaders="true" Expand="true">
                <SpectreTHead>
                    <SpectreTR>
                        <SpectreTH><Markup Content="PID" /></SpectreTH>
                        <SpectreTH><Markup Content="Imagem" /></SpectreTH>
                        <SpectreTH><Markup Content="Inicio" /></SpectreTH>
                        <SpectreTH><Markup Content="Duracao" /></SpectreTH>
                    </SpectreTR>
                </SpectreTHead>
                <SpectreTBody>
                    @foreach (var proc in ActiveSession.Statistics.ProcessosAtivosDetalhados
                                             .OrderByDescending(p => p.IniciadoEm ?? DateTime.MinValue)
                                             .Take(MaxProcessosVisiveis))
                    {
                        var inicio = proc.IniciadoEm?.ToString("HH:mm:ss") ?? "--";
                        var duracao = proc.IniciadoEm is not null
                            ? (CurrentTime - proc.IniciadoEm.Value).ToString("hh\\:mm\\:ss")
                            : proc.DuracaoAtual?.ToString("hh\\:mm\\:ss") ?? "--";

                        <SpectreTR>
                            <SpectreTD><Markup Content='@proc.PID.ToString()' Foreground="@Color.Yellow" /></SpectreTD>
                            <SpectreTD><Markup Content='@Spectre.Console.Markup.Escape(proc.Imagem)' /></SpectreTD>
                            <SpectreTD><Markup Content='@inicio' /></SpectreTD>
                            <SpectreTD><Markup Content='@duracao' /></SpectreTD>
                        </SpectreTR>
                    }
                </SpectreTBody>
            </SpectreTable>
        }

        @if (logsDisponiveis.Count > 0)
        {
            <Newline />
            <Markup Content='@($"Logs recentes ({logsDisponiveis.Count}/{ActiveSession.Logs.Count})")'
                    Decoration="@Decoration.Bold"
                    Foreground="@Color.Grey" />
            @foreach (var log in logsDisponiveis)
            {
                <Markup Content='@("  " + Spectre.Console.Markup.Escape(log))' Foreground="@Color.Grey70" />
            }
        }
    }
    else
    {
        <Newline />
        <Markup Content="Nenhuma sessao ativa. Informe um executavel e pressione Iniciar para comecar o monitoramento."
                Foreground="@Color.Grey" />
    }
</Panel>

@code {
    private const int MaxLogs = 6;
    private const int MaxProcessosVisiveis = 8;

    [Parameter] public bool UseCompactLayout { get; set; }
    [Parameter] public SysmonStatus SysmonStatus { get; set; } = null!;
    [Parameter] public MonitoringSessionSnapshot? ActiveSession { get; set; }
    [Parameter] public DateTime CurrentTime { get; set; }
    [Parameter] public EventCallback OnSessionStateChanged { get; set; }

    private string _monitorTarget = string.Empty;
    private string? _monitorError;

    private async Task StartMonitorAsync()
    {
        if (string.IsNullOrWhiteSpace(_monitorTarget))
        {
            _monitorError = "Informe o nome do executavel.";
            return;
        }

        try
        {
            _monitorError = null;
            AppService.StartMonitoring(_monitorTarget.Trim());
            await OnSessionStateChanged.InvokeAsync();
        }
        catch (Exception ex)
        {
            _monitorError = ex.Message;
        }
    }

    private async Task StopMonitorAsync()
    {
        try
        {
            await AppService.StopActiveSessionAsync().ConfigureAwait(false);
            await OnSessionStateChanged.InvokeAsync();
        }
        catch (Exception ex)
        {
            _monitorError = ex.Message;
        }
    }

    private static string ResolveThreatText(HeuristicThreatSeverityTarja level) => level switch
    {
        HeuristicThreatSeverityTarja.Verde => "VERDE",
        HeuristicThreatSeverityTarja.Amarelo => "AMARELA",
        HeuristicThreatSeverityTarja.Laranja => "LARANJA",
        HeuristicThreatSeverityTarja.Vermelho => "VERMELHA",
        _ => "DESCONHECIDA"
    };

    private static Color ResolveThreatColor(HeuristicThreatSeverityTarja level) => level switch
    {
        HeuristicThreatSeverityTarja.Verde => Color.Green,
        HeuristicThreatSeverityTarja.Amarelo => Color.Yellow,
        HeuristicThreatSeverityTarja.Laranja => Color.Orange3,
        HeuristicThreatSeverityTarja.Vermelho => Color.Red,
        _ => Color.Grey
    };
}
